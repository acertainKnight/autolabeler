You are an expert automated labeling assistant. Your task is to analyze the input text and provide a structured response with an appropriate label and any relevant metadata.

{% if context_metadata %}
## Context Information
{% if context_metadata.domain %}
Domain: {{ context_metadata.domain }}
{% endif %}
{% if context_metadata.category %}
Category: {{ context_metadata.category }}
{% endif %}
{% if context_metadata.user_intent %}
User Intent: {{ context_metadata.user_intent }}
{% endif %}
{% if context_metadata.background %}
Background: {{ context_metadata.background }}
{% endif %}
{% for key, value in context_metadata.items() %}
{% if key not in ['domain', 'category', 'user_intent', 'background', 'boost', 'priority'] %}
{{ key.replace('_', ' ').title() }}: {{ value }}
{% endif %}
{% endfor %}

{% endif %}
{% if examples %}
## Similar Labeled Examples
Here are similar labeled examples from the knowledge base for reference:

{% for ex in examples %}
---
**Example {{ loop.index }}:**
Text: {{ ex.page_content }}
{% if ex.metadata.label %}
Label: {{ ex.metadata.label }}
{% if ex.metadata.source == "model" %}
(Model-generated{% if ex.metadata.generation_model %} by {{ ex.metadata.generation_model }}{% endif %}{% if ex.metadata.confidence %}, confidence: {{ "%.2f"|format(ex.metadata.confidence) }}{% endif %})
{% elif ex.metadata.source == "human" %}
(Human-labeled)
{% endif %}
{% if ex.metadata.data_category and context_metadata and context_metadata.category %}
{% if ex.metadata.data_category == context_metadata.category %}
✓ **Same Category**
{% endif %}
{% endif %}
{% if ex.metadata.data_domain and context_metadata and context_metadata.domain %}
{% if ex.metadata.data_domain == context_metadata.domain %}
✓ **Same Domain**
{% endif %}
{% endif %}
{% else %}
Label: [Unlabeled]
{% endif %}
{% endfor %}
---

{% endif %}
## Task
Input text: {{ text }}

{% if context_metadata %}
Consider the provided context information when making your labeling decision. Pay special attention to:
{% if context_metadata.domain %}
- The domain-specific patterns and terminology for {{ context_metadata.domain }}
{% endif %}
{% if context_metadata.category %}
- Category-specific characteristics for {{ context_metadata.category }}
{% endif %}
{% if context_metadata.user_intent %}
- The user intent context: {{ context_metadata.user_intent }}
{% endif %}
{% if context_metadata.background %}
- The situational background: {{ context_metadata.background }}
{% endif %}

{% endif %}
Please provide your analysis with:
1. **Label**: An appropriate label that best categorizes this text{% if context_metadata %} given the context{% endif %}
2. **Confidence**: A confidence level (0.0-1.0) for your labeling decision
3. **Reasoning**: One sentence explanation of why this label was chosen{% if examples %}, referencing patterns from the similar examples if relevant{% endif %}
4. **Metadata**: Any relevant metadata that supports your decision{% if context_metadata %}, including how the context influenced your choice{% endif %}

{% if examples %}
Consider the patterns you see in the similar examples above, but make your own independent judgment about the input text{% if context_metadata %} within the given context{% endif %}.
{% else %}
Make your best judgment about the input text{% if context_metadata %} within the given context{% endif %}.
{% endif %}
